---
title: "read tiff files"
format: html
editor: visual
---

## Check if file exists

### Check specific path

```{r}
library(fs)
file_path <- "/Data/shinydata/infrarisk/PGA_2475y.tif"
file_is_there <- file_exists(file_path)
file_is_there
```

### List all available files if path not found

```{r}
dir_ls("/Data/shinydata/infrarisk", recurse = TRUE)
```

## Read file

```{r}
library(terra)
my_raster <- rast(file_path)
my_raster
```

## Integrity tests for all hazard layers

Test each hazard TIFF (existence, open with `terra`, dimensions). Paths are defined below so this document runs standalone without `hazard_layers.csv`.

```{r}
library(fs)
library(terra)
library(dplyr)

# Self-contained list of hazard layers (same as hazard_layers.csv) so doc runs without the CSV
base <- "/Data/shinydata/infrarisk"
layers <- data.frame(
  hazard = c(
    "Peak Ground Acceleration PGA - 2475 Years",
    "Peak Ground Acceleration PGA - 1500 Years",
    "Peak Ground Acceleration PGA - 975 Years",
    "Peak Ground Acceleration PGA - 475 Years",
    "Peak Ground Acceleration PGA - 250 Years",
    "Susceptibility Class of Landslides Triggered By Earthquakes",
    "Susceptibility Class of Landslides Triggered By Precipitation - Existing climate",
    "Susceptibility Class of Landslides Triggered By Precipitation - Lower bound",
    "Susceptibility Class of Landslides Triggered By Precipitation - Upper bound",
    "Tropical Cyclone Wind - 250 Years",
    "Tropical Cyclone Wind Climate Change - 250 Years",
    "Tropical Cyclone Wind - 100 Years",
    "Tropical Cyclone Wind Climate Change - 100 Years",
    "Tropical Cyclone Wind - 50 Years",
    "Tropical Cyclone Wind Climate Change - 50 Years",
    "Flood Hazard 1000 Years - Existing climate",
    "Flood Hazard 100 Years - Existing climate",
    "Flood Hazard 200 Years - Existing climate",
    "Flood Hazard 50 Years - Existing climate",
    "Flood Hazard 25 Years - Existing climate",
    "Flood Hazard 10 Years - Existing climate",
    "Flood Hazard 10 Years - SSP1 Lower bound",
    "Flood Hazard 10 Years - SSP5 Upper bound",
    "Drought hazard SPI-6 25-year return period - Existing climate",
    "Drought hazard SPI-6 10-year return period - Existing climate",
    "Average duration of a drought event (SPI-6) - Existing climate",
    "Number of drought events in the analysed period (SPI-6) - Existing climate",
    "Building Exposure Model (BEM) - Total",
    "Population distribution (GHSL) 2020"
  ),
  dataset_url = c(
    file.path(base, "PGA_2475y.tif"),
    file.path(base, "PGA_1500y.tif"),
    file.path(base, "PGA_975y.tif"),
    file.path(base, "PGA_475y.tif"),
    file.path(base, "PGA_250y.tif"),
    file.path(base, "n1_mosaic_wgs84_opt.tif"),
    file.path(base, "n2_mosaic_wgs84_opt.tif"),
    file.path(base, "n3_mosaic_wgs84_opt.tif"),
    file.path(base, "n4_mosaic_wgs84_opt.tif"),
    file.path(base, "Wind_T250.tif"),
    file.path(base, "Wind_CC_T250.tif"),
    file.path(base, "Wind_T100.tif"),
    file.path(base, "Wind_CC_T100.tif"),
    file.path(base, "Wind_T50.tif"),
    file.path(base, "Wind_CC_T50.tif"),
    file.path(base, "global_pc_h1000glob.tif"),
    file.path(base, "global_pc_h100glob.tif"),
    file.path(base, "global_pc_h200glob.tif"),
    file.path(base, "global_pc_h50glob.tif"),
    file.path(base, "global_pc_h25glob.tif"),
    file.path(base, "global_pc_h10glob.tif"),
    file.path(base, "global_rcp26_h10glob.tif"),
    file.path(base, "global_rcp85_h10glob.tif"),
    file.path(base, "spi-06_past_sev1_GF.tif"),
    file.path(base, "spi-06_past_sev2_GF.tif"),
    file.path(base, "spi-06_past_dur_GF.tif"),
    file.path(base, "spi-06_past_num_GF.tif"),
    file.path(base, "bem_5x5_valfis.tif"),
    file.path(base, "GHS_POP_E2020_GLOBE_R2022A_54009_1000_V1_0_wgs84_opt.tif")
  ),
  stringsAsFactors = FALSE
)
```

### Per-file integrity checks

For each `dataset_url`: check file exists, then try `terra::rast()`. Record success/failure and dimensions or error message.

```{r}
results <- vector("list", nrow(layers))
for (i in seq_len(nrow(layers))) {
  path <- layers$dataset_url[i]
  name <- layers$hazard[i]
  res <- list(
    hazard = name,
    path = path,
    exists = file_exists(path),
    read_ok = NA,
    nrow = NA_integer_,
    ncol = NA_integer_,
    nlyr = NA_integer_,
    error = NA_character_
  )
  if (!res$exists) {
    res$error <- "File not found"
    results[[i]] <- res
    next
  }
  r <- tryCatch(terra::rast(path), error = identity)
  if (inherits(r, "error")) {
    res$read_ok <- FALSE
    res$error <- conditionMessage(r)
  } else {
    res$read_ok <- TRUE
    res$nrow <- nrow(r)
    res$ncol <- ncol(r)
    res$nlyr <- nlyr(r)
  }
  results[[i]] <- res
}
integrity <- bind_rows(results)
```

### Summary table

```{r}
integrity %>%
  select(hazard, exists, read_ok, nrow, ncol, nlyr, error) %>%
  knitr::kable()
```

### Failures only (missing or unreadable)

```{r}
failed <- integrity %>%
  filter(!exists | isTRUE(!read_ok))
if (nrow(failed) == 0) {
  "All files exist and could be opened with terra."
} else {
  failed %>%
    select(hazard, path, exists, read_ok, error) %>%
    knitr::kable()
}
```

### Counts

```{r}
list(
  total = nrow(integrity),
  exist = sum(integrity$exists, na.rm = TRUE),
  read_ok = sum(integrity$read_ok %in% TRUE, na.rm = TRUE),
  missing = sum(!integrity$exists, na.rm = TRUE),
  failed_read = sum(integrity$exists & integrity$read_ok %in% FALSE, na.rm = TRUE)
) %>%
  as.data.frame() %>%
  t() %>%
  knitr::kable(col.names = "count")
```